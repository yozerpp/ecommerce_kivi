@model _CartItemsPartial

<div class="col-12 row border-bottom pb-5 mt-3">
    <div class="col-12 col-lg-9 ">
        <p class="fs-3 fw-bold ms-3 text-start">Ürünler</p>
        <ul class="list-group">
            <li class="list-group-item py-0 px-0 mx-0 container-fluid">
                <ul class="list-group-horizontal rounded-1 row p-0">
                    <li class="col-2 d-flex justify-content-center align-items-center list-group-item">
                        <p>Resim</p>
                    </li>
                    <li class="col-2 d-flex justify-content-center align-items-center list-group-item">
                        <p>Başlık</p></li>
                    <li class="col-1 d-flex justify-content-center align-items-center list-group-item">
                        <p>Satıcı</p></li>
                    <li class="col-1 d-flex justify-content-center align-items-center list-group-item">
                        <p>Kupon</p></li>
                    <li class="col-2 d-flex justify-content-center align-items-center list-group-item">
                        <p>Fiyat</p></li>
                    <li class="col-1 d-flex justify-content-center align-items-center list-group-item">
                        <p>Miktar</p></li>
                    <li class="col-2 d-flex justify-content-center align-items-center list-group-item">
                        <p>Toplam</p></li>
                    <li class="col-1"><span class="container-fluid"></span></li>
                </ul>
            </li>
            @if (Model.ViewedCart.Aggregates.ItemCount > 0){
                foreach (var item in Model.ViewedCart.Items){
                    <li class="list-group-item py-0 px-0 card">
                        <ul class="list-group-horizontal row p-0">
                            <li class="col-2 list-group-item d-flex p-0 px-0 align-items-center-center justify-content-center">
                                @{
                                    var data = item.ProductOffer.Product.MainImage?.Data;
                                    data = !string.IsNullOrEmpty(data) ? (data.StartsWith("data:") ? data : ("data:image/jpeg;base64," + data)) : "/default.jpg";
                                }
                                <img src="@(data)" class="img-fluid rounded-0 flex-fill" style="max-height: 7em;" alt="Image of @item.ProductOffer.Product.Name"/>
                            </li>
                            <li class="d-flex list-group-item justify-content-center col-2 p-0 align-items-center">
                                <p>@(item.ProductOffer.Product.Name)</p>
                            </li>
                            <li style="text-wrap: wrap; word-wrap: break-word;" class="col-1 d-flex position-relative align-items-center align-content-center justify-content-center text-center list-group-item text-wrap">
                                <p class="fs-6">@item.ProductOffer.Seller.ShopName</p>
                            </li>
                            <li style="text-wrap: wrap; word-wrap: break-word" class="col-1 text-center position-relative d-inline-flex flex-column align-items-center justify-content-center align-content-center overflow-x-hidden list-group-item text-nowrap">
                                @if (item.CouponId != null){
                                    <p >@(item.CouponId)</p>
                                    <form hx-post="/@(nameof(Cart))?handler=deleteCoupon&FromCart=true" hx-target="#@(Model.ContainerId)" hx-swap="innerHTML">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="productId" value="@item.ProductId"/>
                                        <input type="hidden" name="sellerId" value="@item.SellerId"/>
                                        <button type="button" onclick="htmx.trigger(event.currentTarget.parentElement, 'submit');" class="bi btn p-0 bi-trash-fill text-danger-emphasis bg-white shadow-sm"></button>
                                    </form>
                                }
                                else{
                                    @await Html.PartialAsync("Shared/_PromptablePartial", new _PromptablePartial(){
                                        DisplayText = "Kupon Ekle",
                                        Inputs = [new("productId", "hidden", item.ProductId.ToString()), new("sellerId", "hidden", item.SellerId.ToString()), new(nameof(Cart.CouponId)){PlaceHolder = "Kupon Kodu"}], 
                                        Url = $"/{nameof(Cart)}?handler=coupon",Target = "#" + Model.ContainerId, Classes = "btn btn-primary text-light-emphasis container-fluid px-0", FormClasses = "container-fluid"
                                    })
                                }
                            </li>
                            <li class="col-2 list-group-item position-relative">
                                <div class="h-100  align-content-center justify-content-center">
                                    @if (item.ProductOffer.Discount != 1m){
                                        <div class="d-flex container-fluid justify-content-center align-content-center">
                                            <del class="small fw-bold">@(decimal.Round(item.ProductOffer.Price, 2).ToString("C"))</del>
                                            <p style="font-size: x-small" class="float ms-1 fw-bold text-success">%@(decimal.Round((1m - item.ProductOffer.Discount) * 100m, 1).ToString("F1"))</p>
                                        </div>
                                    }
                                    <div class="container-fluid d-flex align-content-center justify-content-center">
                                        <p style="font-size: large">@(decimal.Round(item.ProductOffer.Price * item.ProductOffer.Discount, 2).ToString("C"))</p>
                                    </div>
                                </div>
                            </li>
                            <li style="padding-left: 3em;" class="col-1 d-flex justify-content-center align-items-center list-group-item">
                                <div>
                                    <p>@item.Quantity</p>
                                </div>
                                <div>
                                    <div class="mx-4 g-5">
                                        <form  hx-target="#@(Model.ContainerId)" hx-post="/Cart?FromCart=true">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="productId" value="@(item.ProductId)"/>
                                            <input type="hidden" name="sellerId" value="@(item.SellerId)"/>
                                            <input type="hidden" name="quantity" value="1"/>
                                            <button type="submit" class="btn-link border-0 p-0 bg-white text-success">
                                                <i class="bi bi-plus-circle-fill fs-5"></i>
                                            </button>
                                        </form>
                                        <form  hx-target="#@(Model.ContainerId)" hx-post="/Cart?FromCart=true">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="productId" value="@(item.ProductId)"/>
                                            <input type="hidden" name="sellerId" value="@(item.SellerId)"/>
                                            <input type="hidden" name="quantity" value="-1"/>
                                            <button type="submit" class="btn-link p-0 border-0 text-warning bg-white">
                                                <i class="bi bi-file-minus-fill fs-5"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </li>
                            <li class="col-2 list-group-item px-0 mx-0 container-fluid d-flex flex-column justify-content-center align-items-center text-center">
                                <partial name="Shared/_ItemPricePartial" model="item.Aggregates"/>
                            </li>
                            <li class="col-1 list-group-item align-content-center align-items-center justify-content-center">
                                <form method="post" hx-target="#@(Model.ContainerId)" hx-swap="innerHTML" hx-post="/Cart?handler=delete&FromCart=true">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="sellerId" value="@item.SellerId"/>
                                    <input type="hidden" name="productId" value="@item.ProductId"/>
                                    <button class="text-decoration-none btn-link p-0 border-0 bg-white text-danger" href="javascript:void(0);">
                                        <i class="bi bi-x-circle-fill fs-5"></i>
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                }
            }
            else{
                <li class="list-group-item d-flex align-items-center justify-content-center">
                    <p>Sepetiniz Boş</p>
                </li>
            }
        </ul>
    </div>
    <div class="card col-12 col-lg-3 justify-content-end">
        <div class="mx-2 align-content-center flex-column">
            @if (Model.ViewedCart.Aggregates.ItemCount > 0){
                if (Model.ViewedCart.Aggregates.BasePrice > Model.ViewedCart.Aggregates.DiscountedPrice){
                    <div class="d-flex justify-content-between">
                        <div class="d-inline-flex gap-1">
                            <del class="small mx-0 fw-bold">@(decimal.Round(Model.ViewedCart.Aggregates.BasePrice, 2).ToString("C"))</del>
                            <p style="font-size: x-small" class="mx-0 text-success float-end">%@(decimal.Round(((Model.ViewedCart.Aggregates.DiscountAmount / Model.ViewedCart.Aggregates.BasePrice) )*100m,2).ToString("F1"))</p>
                        </div>
                        <p>İndirimsiz Fiyat</p>
                    </div>
                }
                if (Model.ViewedCart.Aggregates.DiscountedPrice > Model.ViewedCart.Aggregates.CouponDiscountedPrice){
                    <div class="d-flex justify-content-between">
                        <div class="d-inline-flex gap-1">
                            <del class="small col-auto fw-bold">@(decimal.Round(Model.ViewedCart.Aggregates.DiscountedPrice, 2).ToString("C"))</del>
                            <p style="font-size: x-small" class="small text-secondary col-auto float-end">%@(decimal.Round(((Model.ViewedCart.Aggregates.DiscountedPrice - Model.ViewedCart.Aggregates.CouponDiscountedPrice) / Model.ViewedCart.Aggregates.DiscountedPrice)*100m,2).ToString("F1"))</p>
                        </div>
                        <p class="text-success">İndirimli Fiyat</p>
                    </div> 
                }
                <div class="d-flex justify-content-between">
                    <p class="fs-5">@(decimal.Round(Model.ViewedCart.Aggregates.CouponDiscountedPrice, 2).ToString("C"))</p>
                    <p class="fw-bold">Toplam Fiyat</p>
                </div>
                <div class="d-flex container-fluid px-0  justify-content-end align-content-center">
                    <form class="form-check-inline" asp-page="/@(nameof(Checkout))" method="get">
                        <button style="height: 3em;" class="my-4 align-self-end col-auto btn btn-success">Sepeti Onayla</button>
                    </form>
                </div>
            }
            else{
                <button style="height: 3em;" class="my-4 disabled btn-light align-self-end col-auto btn btn-primary">Sepeti Onayla</button>
            }
        </div>
    </div>
    <div class="container-fluid ps-3 mt-2 justify-content-between">
        <button hx-post="/@(nameof(Cart))?handler=clear&FromCart=true" hx-target="#@(Model.ContainerId)" hx-swap="innerHTML" class="btn  btn-outline-secondary bg-white text-secondary">Sepeti Temizle</button>
    </div>
</div>
