@using Ecommerce.Bl.Interface
@using Ecommerce.Entity
@using Ecommerce.Entity.Views
@using Ecommerce.WebImpl.Pages.Shared.Product
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using Index = System.Index
@using Product = Ecommerce.WebImpl.Pages.Product
@model Ecommerce.WebImpl.Pages.Shared._SearchBarPartial

@{
    var formId = (Model.Target?.ToLowerInvariant().Replace("#","").Replace("-","_") ?? "searchBar") +"Form";
}
<div id="@(formId)" class="search-bar-container">
    <style>
        .search-bar-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }
        
        .search-bar-container .input-group {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .search-bar-container .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: none;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .search-bar-container .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .search-bar-container .btn-outline-light {
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .search-bar-container .btn-outline-light:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }
        
        .search-bar-container .form-control {
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .search-bar-container .form-control:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-bar-container .btn-outline-info {
            background: white;
            border: 1px solid #06b6d4;
            color: #0891b2;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .search-bar-container .btn-outline-info:hover {
            background: #06b6d4;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(6, 182, 212, 0.3);
        }
        
        .search-bar-container .dropdown-menu {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background: white;
            backdrop-filter: blur(10px);
        }
        
        .search-bar-container .dropdown-item {
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
        }
        
        .search-bar-container .dropdown-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        
        .search-bar-container .btn-group {
            gap: 0.75rem;
        }
        
        .search-bar-container .bi-search {
            font-size: 1.1rem;
        }
        
        .search-bar-container #filters {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            min-width: 600px;
            max-width: 800px;
        }
        
        .search-bar-container #filters h4 {
            color: #1f2937;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .search-bar-container #filters .col-6 {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .search-bar-container #filters .col-6 > div:first-child {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
    </style>
    <script>
        let filterDropdown@(formId);
        let orderDropdown@(formId);
        document.addEventListener("DOMContentLoaded", ()=> {
            filterDropdown@(formId)= new bootstrap.Dropdown(document.getElementById('filtersButton'), {
                autoClose: 'outside',reference: document.getElementById('filters')
            });
            orderDropdown@(formId) = new bootstrap.Dropdown(document.getElementById('ordersButton'), {
                autoClose: 'outside',reference: document.getElementById('order')
            });
            (()=>{
               document.getElementById('@(formId)Submit').addEventListener('click', e=>{
                   if(Array.from(document.getElementById('filters').querySelectorAll('input')).map(i=>i.reportValidity()).some(b=>!b))
                       return;
                   let params=[];
                   // Add Product Name
                   const searchNameInput = document.getElementById('@(formId)Search');
                   if (searchNameInput && searchNameInput.value) {
                       params.push(`@(nameof(Entity.Product.Name))=${(searchNameInput.value)}`);
                   }

                   // Add Category
                   const categoryIdInput = document.getElementById('categoryIdInput');
                   if (categoryIdInput && categoryIdInput?.value!==undefined && categoryIdInput.value !== '0' && categoryIdInput.value !== '') {
                       params.push(`@(nameof(Entity.Product.Category))_@(nameof(Category.Id))=${(categoryIdInput.value)}`);
                   }

                   // Add Range Filters
                   document.getElementById('ranges').querySelectorAll('.input-group').forEach(i=>{
                       if(i._isEntered!==true)return; // Assuming _isEntered and _name, _max, _min are set by the slider partial
                       params.push(`&(${(i._name)}<=${(i._max)},${(i._name)}>=${(i._min)})`);
                   });
                   // Add Category Properties
                   const categoryProperties = document.getElementById('categoryProperties').firstElementChild;
                   if (categoryProperties && categoryProperties._hasProps) {
                        const ar = Array.from(categoryProperties._props.entries());
                        const qs = ar.map(e=>{
                            const [k,v] = e;
                            let q = 
                                `&(@(nameof(Entity.Product.CategoryProperties))_@(nameof(ProductCategoryProperty.CategoryPropertyId))=${k},`;
                            if(v.hasOwnProperty('min')){
                                q += `@(nameof(Entity.Product.CategoryProperties))_@(nameof(ProductCategoryProperty.Value))>=${v.min},`+
                                `@(nameof(Entity.Product.CategoryProperties))_@(nameof(ProductCategoryProperty.Value))<=${v.max})`;
                            } else if(v.hasOwnProperty('enumValue')){
                                q+=`@(nameof(Entity.Product.CategoryProperties))_@(nameof(ProductCategoryProperty.Value))=${v.enumValue}`
                            } else q += `@(nameof(Entity.Product.CategoryProperties))_@(nameof(ProductCategoryProperty.Value))=${v}`;
                            return q + ')';
                        });
                        if(ar.length > 0)
                            params.push('|('+qs.join(',') + ')');
                        else params.push(qs[0]);
                   }
                   let orderings = [];
                   const orderList = document.getElementById('order').firstElementChild;
                   orderList._orders.entries().forEach(e=>{
                       [k,v] = e;
                       if(v.selected){
                           orderings.push({property:k, value: v.ascending?'ASC': 'DESC'})
                       }
                   });
                   
                   // Remove leading '&' if present
                    let querystringparam='';
                    let orderstringparam='';
                    if(params.length > 0){
                        querystringparam ='@(nameof(HomepageModel.QueryString))=' + encodeURIComponent('&(' + params.join(',') + ')');
                    } 
                    if(orderings.length > 0){
                        orderstringparam = '@(nameof(HomepageModel.OrderString))=' + encodeURIComponent(orderings.map(p=>`${p.property};${p.value}`).join('&&'))
                    }
                    let url;
                    if(orderings.length ===0 && params.length === 0){
                        url = '/Index';
                    }else url = '/Index?' + querystringparam + '&' + orderstringparam;
                   @if (Model.ViewType == HomepageModel.ViewType_.Page){
                   <text>
                        window.location.replace( url);
                   </text>
                   }
                   else{
                    <text>
                   console.log('Target element exists:', document.querySelector('@(Model.Target)'));
                        htmx.ajax('GET', url + (orderings.length ===0 && params.length ===0?'?':'&')+"@(nameof(HomepageModel.ViewType))=@(Model.ViewType)", {
                            target: '@(Model.Target)',
                            swap: 'innerHTML',
                        });
                    </text>
                   }
               });
            })()
        });
    </script>
    @Html.AntiForgeryToken()
    <input type="hidden" id="categoryIdInput" name="@(nameof(HomepageModel.SearchCategory))"/>
    <div class="d-flex gap-1">
        <div class="input-group rounded-start-2">
            <button hx-get="" hx-trigger="go" id="@(formId)Submit" class="input-group-text rounded-start-2 rounded-end-0 btn-primary btn" type="button">
                <i class="bi bi-search m-0" style="font-size: large"></i>
            </button>
            <div class="dropdown my-0">
                <button id="pickerBtn" class="my-0 dropdown-toggle btn btn-outline-light text-dark rounded-0 box-shadow" data-bs-toggle="dropdown" data-bs-target="#categoryPicker" aria-expanded="false">Tüm Kategoriler</button>
                <div id="categoryPicker" class="dropdown-menu rounded-bottom-2 border-1">
                    <script>
                        ((s)=>{
                            document.addEventListener("DOMContentLoaded", ()=>{
                                const picker = s.nextElementSibling;
                                picker.addEventListener('change', e=>{
                                    s.parentElement.previousElementSibling.innerHTML = picker.dataset.name;
                                    document.getElementById('categoryIdInput').value = picker.dataset.id === '0'?null:picker.dataset.id;
                                    if(picker.dataset.id==='0') return;
                                    document.getElementById('categoryProperties').setAttribute('hx-vals', JSON.stringify({@Html.Raw("\"categoryId\""): picker.dataset.id}));
                                    htmx.trigger(document.getElementById('categoryProperties'), 'fire')
                                });
                            });
                        })(document.currentScript)
                    </script>
                    @await Html.PartialAsync("Shared/SearchBar/_CategoryPicker", new _CategoryPicker(Model.Categories, rootElementId:Model.Target==null?"searchBarCategoryPicker":Model.Target?.Replace("#","") + "_categoryPicker"){NonSelectionText = "Tüm Kategoriler"})
                </div>
            </div>
            <input id="@(formId)Search" class="rounded-1 rounded-start-0 form-control" type="text" @Html.Raw(Model.Target!=null?$"onchange=\"document.getElementById('{formId}Submit').dispatchEvent(new Event('click', {{cancelable: true, bubbles: true}}))\"":"") value="@null" name="@(nameof(HomepageModel.SearchName))" />
        </div>
        <div class="btn-group justify-content-center mx-1 align-items-center gap-2">
            <button type="button" class="dropdown-toggle btn btn-outline-info"  onclick="filterDropdown@(formId).toggle();event.stopImmediatePropagation();">
                Filtreler
            </button>
            <div class="dropdown">
                <button  type="button" id="ordersButton" class="btn btn-outline-light text-dark dropdown-toggle"  
                        data-bs-toggle="dropdown" data-bs-target="#order" aria-expanded="false">Sıralama</button>
                <div id="order" class="dropdown-menu">
                    @await Html.PartialAsync("Shared/SearchBar/_OrderingPartial", new _OrderingPartial())
                </div>
            </div>
        </div>
    </div>
    <div class="dropdown">
        <button type="button" id="filtersButton" role="button" class="dropdown-toggle" data-bs-toggle="dropdown" hidden aria-expanded="false"></button>
        <div id="filters" class="dropdown-menu border-top-0 rounded-2">
            <ul class="list-unstyled gap-3 g-3">
                <li hx-on::after-settle="console.log(event.detail.elt.firstElementChild);event.detail.elt.firstElementChild.dispatchEvent(new Event('init', {bubbles:false}));"
                    id="categoryProperties" hx-get="/@(nameof(Product))?handler=categoryProperties&Type=@(nameof(_CategoryPropertiesPartial.DisplayMode.Filter))&idPrefix=@(nameof(HomepageModel.PropertyFilters))" hx-target="this" hx-swap="innerHTML" hx-trigger="fire">
                </li>
                <li id="ranges" class="row row-cols-6 g-2 d-flex ps-2">
                    <h4 class="fw-bold col-12 fs-5">İstatistik Özellikleri</h4>
                    <div class="col-6 gap-1">
                        <div>
                            Satılma Sayısı
                        </div>
                        <div id="saleCountRange">
                            @await Html.PartialAsync("Shared/SearchBar/_SliderPartial", new _SliderPartial(){
                                MaxValue = 1000000,
                                MinValue = 0,
                                InputName = string.Join('_', nameof(Entity.Product.Stats), nameof(ProductStats.SaleCount)),
                            })
                        </div>
                    </div>
                    <div class="col-6 gap-1">
                        <div>İade Sayısı</div>
                        <div id="refundCountRange">
                            @await Html.PartialAsync("Shared/SearchBar/_SliderPartial", new _SliderPartial(){
                                MaxValue = 1000000,
                                MinValue = 0,
                                InputName = string.Join('_', nameof(Entity.Product.Stats), nameof(ProductStats.RefundCount)),
                            })
                        </div>
                    </div>
                    <div class="col-6 gap-1">
                        <div>
                            Favorilere Eklenme Sayısı
                        </div>
                        <div id="favoriteRange">
                            <input type="hidden" name=""/>
                            @await Html.PartialAsync("Shared/SearchBar/_SliderPartial", new _SliderPartial(){
                                MaxValue = 1000000,
                                MinValue = 0,
                                InputName = string.Join('_', nameof(Entity.Product.Stats), nameof(ProductStats.FavorCount)),
                            })
                        </div>
                    </div>
                    <div class="col-6 gap-1">
                        <div>
                            Değerlendirme Sayısı
                        </div>
                        <div id="ratingCountRange">
                            @await Html.PartialAsync("Shared/SearchBar/_SliderPartial", new _SliderPartial(){
                                MaxValue = 1000000,
                                MinValue = 0,
                                InputName = string.Join('_', nameof(Entity.Product.Stats), nameof(ProductStats.ReviewCount)),
                            })
                        </div>
                    </div>
                    <div class="col-6 gap-1">
                        <div>
                            Değerlendirme Ortalaması
                        </div>
                        <div id="ratingRange">
                            @await Html.PartialAsync("Shared/SearchBar/_SliderPartial", new _SliderPartial(){
                                MinValue = 0,
                                MaxValue = 5,
                                Step = "0.1",
                                InputName = string.Join('_', nameof(Entity.Product.Stats), nameof(ProductStats.RatingAverage)),
                            })
                        </div>
                    </div>
                    <div class="col-6 gap-1">
                        <div>Fiyat</div>
                        <div id="priceRange">
                            @await Html.PartialAsync("Shared/SearchBar/_SliderPartial", new _SliderPartial(){
                                MaxValue = 1000000, MinValue = 0,
                                Step = "0.1",
                                InputName = string.Join('_', nameof(Entity.Product.Stats), nameof(ProductStats.MinPrice)),
                            })
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>
