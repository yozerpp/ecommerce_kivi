@using Bogus
@using Ecommerce.Entity
@using Utils = Ecommerce.WebImpl.Pages.Shared.Utils
@inject IDictionary<uint,Category> Categories
@model Ecommerce.WebImpl.Pages.Seller._OffersPartial

<div class="my-3" id="offers">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Ürün İlanları</h6>
        <form id="offersPageSizeForm" method="get" hx-get="/Seller?handler=offers" hx-target="#offers" hx-swap="outerHTML" class="d-flex align-items-center">
            <input type="hidden" name="@(nameof(Model.OffersPage))" value="@(Model.OffersPage)"/>
            <input type="hidden" name="@(nameof(SellerModel.Id))" value="@(Model.Id)"/>
            <label class="form-label me-2 mb-0">Sayfa boyutu:</label>
            <select onchange="document.getElementById('offersPageSizeForm').dispatchEvent(new Event('submit',{cancelable:true, bubbles:true}))" class="form-select form-select-sm" name="@(nameof(Model.OffersPageSize))" style="width: auto;">
                @{ var ar = new int[]{ 20, 10, 50, 100 }; }
                @for (int i = 0; i < ar.Length; i++){
                    <option selected="@(Model.OffersPageSize == ar[i])" value="@(ar[i])">@(ar[i])</option>
                }
            </select>
        </form>
    </div>

    <ul class="list-group bg-light">
        <li class="list-group-item py-2 px-0 bg-primary text-white">
            <ul class="list-group-horizontal row p-0">
                <li class="col-3 list-group-item d-flex p-0 px-0 align-items-center justify-content-center bg-primary text-white border-0">
                    <p class="fs-6 fw-bold mb-0">Ana Görsel</p>
                </li>
                <li class="d-flex list-group-item justify-content-center col-2 p-0 align-items-center bg-primary text-white border-0">
                    <p class="fs-6 fw-bold mb-0">İsim</p>
                </li>
                <li class="col-2 d-flex position-relative align-items-center align-content-center justify-content-center text-center list-group-item bg-primary text-white border-0">
                    <p class="fs-6 fw-bold mb-0">Kategori</p>
                </li>
                <li class="col-2 list-group-item position-relative bg-primary text-white border-0">
                    <p class="fs-6 fw-bold mb-0">Fiyat</p>
                </li>
                <li class="col-3 text-center position-relative d-inline-flex flex-column align-items-center justify-content-center align-content-center list-group-item bg-primary text-white border-0">
                    <p class="fs-6 fw-bold mb-0">İndirim %</p>
                </li>
            </ul>
        </li>
        @foreach (var offer in Model.ProductOffers){
            <li data-id="@offer.Product.Id" onclick="event.currentTarget.parentElement._selected?.classList.remove('bg-secondary-subtle');event.currentTarget.classList.add('bg-secondary-subtle');event.currentTarget.parentElement._selected = event.currentTarget" class="hover-darken-2 list-group-item py-0 px-0">
                <a asp-page="/Product" asp-route-ProductId="@(offer.Product.Id)" class="text-decoration-none text-dark">
                    <ul class="list-group-horizontal row p-0">
                        <li class="col-3 list-group-item d-flex p-0 px-0 align-items-center justify-content-center">
                            <img src="@(Utils.GetImageUrlOrDefault(offer.Product.MainImage?.Data))" class="img-fluid rounded-0 flex-fill" style="max-height: 7em;" alt="image of @(offer.Product.Name)"/>
                        </li>
                        <li class="d-flex list-group-item justify-content-center col-2 p-0 align-items-center">
                            <p class="fs-4 fw-bold mb-0">@(offer.Product.Name)</p>
                        </li>
                        <li style="text-wrap: wrap; word-wrap: break-word;" class="col-2 d-flex position-relative align-items-center align-content-center justify-content-center text-center list-group-item text-wrap">
                            <p class="fs-5 mb-0">@((Categories.TryGetValue(offer.Product.CategoryId, out var val)?val:null)?.Name ?? "Kategori yok")</p>
                        </li>
                        <li class="col-2 list-group-item position-relative d-flex align-items-center">
                            <p class="fs-6 mb-0 fw-semibold text-success">@(offer.Price.ToString("C"))</p>
                        </li>
                        <li style="text-wrap: wrap; word-wrap: break-word" class="col-3 text-center position-relative d-inline-flex flex-column align-items-center justify-content-center align-content-center overflow-x-hidden list-group-item text-nowrap">
                            <p class="fs-6 mb-0 fw-semibold text-danger">%@(((1m - offer.Discount) * 100).ToString("F0"))</p>
                        </li>
                    </ul>
                </a>
            </li>
        }
    </ul>
    <nav class="mt-3">
        <ul class="pagination justify-content-center align-items-center">
            <li class="page-item">
                <a class="page-link" hx-trigger="click" hx-target="#offers" hx-swap="outerHTML" hx-get="@GetHrefString(1)">
                    <span>İlk</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" hx-trigger="click" hx-target="#offers" hx-swap="outerHTML" hx-get="@GetHrefString(Model.OffersPage - 1)">
                    <i class="bi bi-arrow-left"></i>
                </a>
            </li>
            <li class="page-item">
                <span class="page-link bg-light">Sayfa @Model.OffersPage</span>
            </li>
            <li class="page-item">
                <a class="page-link" hx-trigger="click" hx-target="#offers" hx-swap="outerHTML" hx-get="@GetHrefString(Model.OffersPage + 1)">
                    <i class="bi bi-arrow-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" hx-trigger="click" hx-target="#offers" hx-swap="outerHTML" hx-get="@GetHrefString(-1)">
                    <span>Son</span>
                </a>
            </li>
        </ul>
    </nav>

</div>
@functions{
    private string GetHrefString(int? offersPage=null,int? offserPageSize = null) {
        offersPage??= Model.OffersPage;
        offserPageSize ??= Model.OffersPageSize;
        return $"/Seller?handler=offers&{nameof(SellerModel.Id)}={Model.Id}&{nameof(Model.OffersPage)}={offersPage}&{nameof(Model.OffersPageSize)}={offserPageSize}";
    }

}
