@using Bogus
@using Ecommerce.Entity
@using Utils = Ecommerce.WebImpl.Pages.Shared.Utils
@inject IDictionary<uint,Category> Categories
@model Ecommerce.WebImpl.Pages.Seller._OffersPartial

<div class="my-3" id="offers">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Ürün İlanları</h6>
        <form id="offersPageSizeForm" method="get" hx-get="/Seller?handler=offers" hx-target="#offers" hx-swap="outerHTML" class="d-flex align-items-center">
            <input type="hidden" name="@(nameof(Model.OffersPage))" value="@(Model.OffersPage)"/>
            <input type="hidden" name="@(nameof(SellerModel.Id))" value="@(Model.Id)"/>
            <label class="form-label me-2 mb-0">Sayfa boyutu:</label>
            <select onchange="document.getElementById('offersPageSizeForm').dispatchEvent(new Event('submit',{cancelable:true, bubbles:true}))" class="form-select form-select-sm" name="@(nameof(Model.OffersPageSize))" style="width: auto;">
                @{ var ar = new int[]{ 20, 10, 50, 100 }; }
                @for (int i = 0; i < ar.Length; i++){
                    <option selected="@(Model.OffersPageSize == ar[i])" value="@(ar[i])">@(ar[i])</option>
                }
            </select>
        </form>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white py-3">
            <div class="row g-2 align-items-center">
                <div class="col-3 text-center">
                    <h6 class="mb-0 fw-bold">Ana Görsel</h6>
                </div>
                <div class="col-2 text-center">
                    <h6 class="mb-0 fw-bold">İsim</h6>
                </div>
                <div class="col-2 text-center">
                    <h6 class="mb-0 fw-bold">Kategori</h6>
                </div>
                <div class="col-2 text-center">
                    <h6 class="mb-0 fw-bold">Fiyat</h6>
                </div>
                <div class="col-3 text-center">
                    <h6 class="mb-0 fw-bold">İndirim %</h6>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            @foreach (var offer in Model.ProductOffers){
                <div data-id="@offer.Product.Id" 
                     onclick="event.currentTarget.parentElement._selected?.classList.remove('bg-light');event.currentTarget.classList.add('bg-light');event.currentTarget.parentElement._selected = event.currentTarget" 
                     class="border-bottom hover-darken transition-all">
                    <a asp-page="/Product" asp-route-ProductId="@(offer.Product.Id)" class="text-decoration-none text-dark d-block p-3">
                        <div class="row g-2 align-items-center">
                            <div class="col-3 text-center">
                                <img src="@(Utils.GetImageUrlOrDefault(offer.Product.MainImage?.Data))" 
                                     class="img-fluid rounded shadow-sm" 
                                     style="max-height: 80px; max-width: 80px; object-fit: cover;" 
                                     alt="image of @(offer.Product.Name)"/>
                            </div>
                            <div class="col-2 text-center">
                                <h6 class="mb-0 fw-semibold text-truncate">@(offer.Product.Name)</h6>
                            </div>
                            <div class="col-2 text-center">
                                <span class="badge bg-secondary">@((Categories.TryGetValue(offer.Product.CategoryId, out var val)?val:null)?.Name ?? "Kategori yok")</span>
                            </div>
                            <div class="col-2 text-center">
                                <span class="fs-5 fw-bold text-success">@(offer.Price.ToString("C"))</span>
                            </div>
                            <div class="col-3 text-center">
                                <span class="badge bg-danger fs-6">%@(((1m - offer.Discount) * 100).ToString("F0")) İndirim</span>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item">
                <a class="page-link rounded-pill me-1" hx-trigger="click" hx-target="#offers" hx-swap="outerHTML" hx-get="@GetHrefString(1)">
                    <i class="bi bi-chevron-double-left"></i> İlk
                </a>
            </li>
            <li class="page-item">
                <a class="page-link rounded-pill me-1" hx-trigger="click" hx-target="#offers" hx-swap="outerHTML" hx-get="@GetHrefString(Model.OffersPage - 1)">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            <li class="page-item">
                <span class="page-link bg-primary text-white rounded-pill mx-2 fw-bold">Sayfa @Model.OffersPage</span>
            </li>
            <li class="page-item">
                <a class="page-link rounded-pill ms-1" hx-trigger="click" hx-target="#offers" hx-swap="outerHTML" hx-get="@GetHrefString(Model.OffersPage + 1)">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link rounded-pill ms-1" hx-trigger="click" hx-target="#offers" hx-swap="outerHTML" hx-get="@GetHrefString(-1)">
                    Son <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
        </ul>
    </nav>

</div>
@functions{
    private string GetHrefString(int? offersPage=null,int? offserPageSize = null) {
        offersPage??= Model.OffersPage;
        offserPageSize ??= Model.OffersPageSize;
        return $"/Seller?handler=offers&{nameof(SellerModel.Id)}={Model.Id}&{nameof(Model.OffersPage)}={offersPage}&{nameof(Model.OffersPageSize)}={offserPageSize}";
    }

}
