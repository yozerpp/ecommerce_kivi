@page
@using System.Globalization
@using System.Reflection.Metadata
@using Ecommerce.Entity
@using Ecommerce.Entity.Common
@using Ecommerce.WebImpl.Pages.CustomerPartials
@using Ecommerce.WebImpl.Pages.Shared
@using Ecommerce.WebImpl.Pages.Shared.Order
@using Org.BouncyCastle.Crypto.Engines
@model Ecommerce.WebImpl.Pages.Checkout

@section Scripts{
    @if (Model.SelectedTab == 1){
        <script>
            @if (Model.CurrentCustomer != null){
                <text>
                    document.addEventListener("DOMContentLoaded", ()=>{
                       document.querySelectorAll('.edit-control').forEach(e=>e.classList.remove('edit-control')); 
                    });
                </text>
            }
            let selectedTab = @(Model.SelectedTab -1 );
            let navTabs = [];
            document.addEventListener("DOMContentLoaded", () => {
                const c = document.getElementById('nav-tab').children;
                for (let i = 0; i < c.length; i++) {
                    if(c[i].nodeType === Node.ELEMENT_NODE)
                        navTabs[i] = c[i];
                }
            });
            function goBack(event){
                event.currentTarget.classList.add('d-none');
                document.getElementById('forwardBtn').classList.remove('d-none');
                document.getElementById('proceedForm').classList.add('d-none');
                goToTab(selectedTab, --selectedTab);
            }
            function goToTab(oldTabIdx, newTabIdx){
                let oldTabId = navTabs[oldTabIdx].getAttribute('data-bs-target').replace('#','');
                document.getElementById(oldTabId).classList.remove('show','active');
                navTabs[oldTabIdx].classList.remove('active');
                navTabs[newTabIdx].classList.add('active');
                let targetId = navTabs[newTabIdx].getAttribute('data-bs-target').replace('#','');
                document.getElementById(targetId).classList.add('show', 'active');
            }
            function goForward(event){
                goToTab(selectedTab, ++selectedTab);
                document.getElementById('backBtn').classList.remove('d-none');
                document.getElementById('proceedForm').classList.remove('d-none');
                event.currentTarget.classList.add('d-none');
            }
            function assignCheckoutInputs() {
                @{ var acsor = Model.CurrentCustomer == null ? "value" : "innerText";}
               const addrIdPostfix = @(Html.Raw(Model.CurrentCustomer!=null? "'address' + document.getElementById('customerAddress')._selectedIndex?.toString() ?? ''":"''"));
               @if (Model.CurrentCustomer == null){
                   <text>
                   document.getElementById('@(nameof(Checkout.Name))Input').value = document.getElementById('name').@acsor;
                   document.getElementById('@(nameof(Checkout.Email))Input').value= document.getElementById('email').@acsor;
                    </text>
               }
               document.getElementById('@(nameof(Address.City))Input').value = document.getElementById( '@(nameof(Address.City))_'+addrIdPostfix).@acsor;
               document.getElementById('@(nameof(Address.Line1))Input').value= document.getElementById('@nameof(Address.Line1)_' + addrIdPostfix).@acsor;
               document.getElementById('@nameof(Address.Line2)Input').value= document.getElementById('@nameof(Address.Line2)_' + addrIdPostfix).@acsor;
               document.getElementById('@(nameof(Address.District))Input').value = document.getElementById( '@nameof(Address.District)_' + addrIdPostfix).@acsor;
               document.getElementById('@(nameof(Address.ZipCode))Input').value = document.getElementById('@nameof(Address.ZipCode)_' + addrIdPostfix).@acsor;
               document.getElementById('@(nameof(Address.Country))Input').value = document.getElementById('@nameof(Address.Country)_' + addrIdPostfix).@acsor;
               document.getElementById('countrycodeInput').value = document.getElementById('@(nameof(PhoneNumber.CountryCode))').@acsor;
               document.getElementById('numberInput').value = document.getElementById('@(nameof(PhoneNumber.Number))').@acsor;
            }
            let selectedOffers = new Map();
            function selectOffer(event, sellerId){
                event.currentTarget.parentElement._selectedGroup?.classList?.remove('bg-light');
                event.currentTarget.parentElement._selectedGroup = event.currentTarget;
                event.currentTarget.classList.add('bg-light');
                const offerId =  event.currentTarget.id.replace('offer-', '');
                selectedOffers.set(sellerId, offerId);
                document.getElementById('group-' + sellerId + '-input').value =offerId;
            }
            function selectGroup(event, sellerId){
                document.getElementById('offers')._active?.classList?.add('d-none');
                const _new = document.getElementById('offers-' + sellerId.toString());
                document.getElementById('offers')._active=_new; 
                _new.classList.remove('d-none');
            }
            function assignShippingInputs(event){
                selectedOffers.forEach((v,k,_) => {
                    document.getElementById(`group-${k.toString()}-input`).value = v;
                });
                if(selectedOffers.size < @(Model.ShippingOffersGrouped.Count)){
                    alert("Lütfen Sepetinizdeki tüm satıcılar için kargo seçimi yapın.")
                    event.stopImmediatePropagation();
                }
            }
        </script>
    }
    else if (Model.SelectedTab == 3){
        <script src="https://js.stripe.com/basil/stripe.js"></script>
        <script>
            let stripe = Stripe('@(ViewData["StripePublicKey"])')
            let elems;
            document.addEventListener("DOMContentLoaded", () => {
                elems = stripe.elements({
                    clientSecret: '@(ViewData["IntentSecret"] ?? throw new ArgumentNullException("IntentSecret"))',
                    customerSessionClientSecret: '@(ViewData["SessionSecret"]?? throw new ArgumentNullException("SessionSecret"))',
                    loader: 'always',
                });
                let paymentElement = elems.create('payment', {layout: 'accordion'});
                paymentElement.mount('#paymentElements');
            })
            async function sendPayment(e){
                e.preventDefault();
                e.stopImmediatePropagation();
                e.stopPropagation();
                const {error} = await stripe.confirmPayment({
                    elements: elems,
                    confirmParams: {
                        return_url: '@Html.Raw(ViewData["ReturnUrl"]??throw new ArgumentNullException())'
                    }
                });
            }
        </script>
    } 
}
<div class="container-fluid">
    <nav>
        <div class="nav nav-tabs flex-row container-fluid align-content-center justify-content-center" id="nav-tab" role="tablist">
            <button disabled onclick="event.stopImmediatePropagation()" class="nav-link @(Model.SelectedTab==1?"active":"")" id="nav-info-tab" data-bs-toggle="tab" data-bs-target="#nav-info" type="button" role="tab" aria-controls="nav-info" aria-selected="true">Sepeti Onayla</button>
            <button disabled onclick="event.stopImmediatePropagation()" class="nav-link" id="nav-shipment-tab" data-bs-toggle="tab" data-bs-target="#nav-shipment" type="button" role="tab" aria-controls="nav-shipment" aria-selected="false">Kargo Seçimi</button>
            <button disabled onclick="event.stopImmediatePropagation()" class="nav-link @(Model.SelectedTab==3?"active":"")" id="nav-payment-tab" data-bs-toggle="tab" data-bs-target="#nav-payment" type="button" role="tab" aria-controls="nav-payment" aria-selected="false">Ödeme</button>
            <button disabled onclick="event.stopImmediatePropagation()" class="nav-link @(Model.SelectedTab==4?"active":"")" id="nav-result-tab" data-bs-toggle="tab" data-bs-target="#nav-result" type="button" role="tab" aria-controls="nav-result" aria-selected="false">Siparişi Görüntüle</button>
        </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane section rounded fade @(Model.SelectedTab==1?"show active":"")" id="nav-info" role="tabpanel" aria-labelledby="nav-info-tab">
            @if (Model.SelectedTab == 1){
                <div class="row g-5">
                    <div class="col-12 p-3 col-lg-7">
                        <div class=" p-4 h-100">
                            @if (Model.CurrentCustomer == null)
                            {
                                <div class="mb-3 ps-3">
                                    <h2 class="align-self-start">İletişim Bilgilerini Gir</h2>
                                    <div class="d-flex mt-3 flex-column gap-3">
                                        <div class="d-inline-flex justify-content-between">
                                            <div class="gap-3">
                                                <label class="fs-5">İsim</label>
                                                <input id="name" class="border-1 mx-2 shadow rounded-1" type="text" placeholder="İsim"/>    
                                            </div>
                                            <div class="gap-3">
                                                <label class="fs-5">E-Posta</label>
                                                <input class="border-1 mx-2 shadow-sm" id="email" placeholder="Email" type="email"/>
                                            </div>
                                        </div>
                                        <div class="d-inline-flex gap-1">
                                            <label class="fs-5">Tel</label>
                                            @await Html.PartialAsync(nameof(_PhoneNumberPartial), new _PhoneNumberPartial(){ IsInput = true })
                                        </div>
                                    </div>
                                </div>
                                <div class="border-bottom my-3 border-secondary-subtle my-3 border-1"></div>
                            }
                            <div class="mb-3 gap-2">
                                <h2 class="align-self-start mx-3">Teslimat Adresini @(Model.CurrentCustomer == null ? "Gir" : "Onayla")</h2>
                                <div id="address" class="mx-3">
                                    @if (Model.CurrentCustomer == null || Model.CurrentCustomer.Addresses.Count==0){
                                        <partial name="Shared/_AddressPartial"
                                                 model="new _AddressPartial(){ Address = Model.CurrentCustomer?.PrimaryAddress ?? new Address(), Editable = true, AsInput=Model.CurrentCustomer==null }"/>
                                    }else {
                                        @await Html.PartialAsync("Shared/Customer/"+nameof(_CustomerAddressPartial), new _CustomerAddressPartial(){Addresses = Model.CurrentCustomer.Addresses, Updateable = false, Editable = true, CustomerId = Model.CurrentCustomer.Id})
                                    }
                                </div>
                            </div>
                            @if (Model.CurrentCustomer != null){
                                <div  class="m-3 gap-2">
                                    <h2 class="mx-1">Telefon Numaranı Onayla</h2>
                                    @await Html.PartialAsync(nameof(_PhoneNumberPartial), new _PhoneNumberPartial(){Editable = true, PhoneNumber = Model.CurrentCustomer.PhoneNumber})
                                </div>
                            }
                        </div>
                    </div>
                    <div class="col-12 border-start p-4 border-light-subtle border-2 col-lg-5">
                        <div class="h-100">
                            <ul class="list-group">
                                @foreach (var item in Model.Cart.Items)
                                {
                                    <li class="list-inline-item row mb-3">
                                        <!-- Product Image -->
                                        <div class="col-auto">
                                            
                                            <img src="@(Utils.GetImageUrlOrDefault(item.ProductOffer.Product.MainImage?.Data))" style="height: 10em;" class="img-fluid rounded" alt="image of @item.ProductOffer.Product.Name" />
                                        </div>
                                        <!-- Product Info -->
                                        <div class="col">
                                            <p class="fw-bold mb-1">@item.ProductOffer.Product.Name</p>
                                            <p class="text-muted mb-1">@item.ProductOffer.Seller.ShopName</p>
                                            <p class="text-success mb-1">
                                                @((item.ProductOffer.Price * item.ProductOffer.Discount * (item.Coupon?.DiscountRate ?? 1m)).ToString("C"))
                                            </p>
                                            <p class="mb-1">Adet: @item.Quantity</p>
                                            <p class="fw-semibold">Toplam: @decimal.Round(item.Aggregates.CouponDiscountedPrice.Value,2).ToString("C")</p>
                                        </div>
                                    </li>
                                }
                            </ul>

                        </div>

                    </div>
                </div>

            }
        </div>
        
        <!--Shipment Tab-->
        
        <div class="tab-pane fade" id="nav-shipment" role="tabpanel" aria-labelledby="nav-shipment-tab">
            @if (Model.SelectedTab == 1){
                <div class="container-fluid row g-4">
                    <div id="items" class="col-8 card-group d-flex flex-column list-unstyled px-5">
                        @foreach (var itemGroup in Model.Cart.Items.GroupBy(i => i.ProductOffer.Seller).OrderBy(i=>i.Key.Id.GetHashCode())){
                            <div onclick="selectGroup(event, @(itemGroup.Key.Id))" style="cursor: pointer" id="group-@itemGroup.Key.Id" class="card border-start rounded">
                                <div class="mb-4 card-header bg-light">
                                    <p class="fw-bold card-title fs-6">@itemGroup.Key.ShopName Satıcısının Ürünleri</p>
                                </div>
                                <ul class="card-body pt-1">
                                    @foreach (var item in itemGroup.OrderBy(i=>i.ProductId.GetHashCode())){
                                        <li class=" my-3 d-flex flex-row justify-content-start text-center align-content-center align-items-center border-secondary-subtle hover-darken row">
                                            <div class="col-3 d-inline-flex justify-content-center align-content-center align-items-center p-0">
                                                <img class="img-fluid rounded-1" alt="@item.ProductOffer.Product.Name Resmi" src="@(Utils.GetImageUrlOrDefault(item.ProductOffer.Product.MainImage?.Data))"/>
                                            </div>
                                            <div class="col-2 d-inline-flex justify-content-center align-content-center align-items-center">
                                                <p class="fs-5">@(item.ProductOffer.Product.Name)</p>
                                            </div>
                                            <div class="col-3"></div>
                                        </li>
                                    }     
                                </ul>
                            </div> 
                        }
                    </div>
                    <div class="col-4 section p-0">
                        <div id="offers">
                            @foreach (var (sellerId, offers) in Model.ShippingOffersGrouped){
                                <ul class="list-group p-0 d-none rounded-3 shadow-sm" style="cursor: pointer;" id="offers-@(sellerId)">
                                    @foreach (var offer in offers){
                                        <li onclick="selectOffer(event, @(sellerId))" id="offer-@(offer.Id)" class="hover-darken list-group-item border-0 mb-3 rounded-3 shadow-sm transition-all">
                                            <div class="card h-100">
                                                <div class="card-header bg-primary text-white text-center py-3">
                                                    <h5 class="mb-0 fw-bold">@offer.Provider.Name</h5>
                                                </div>
                                                <div class="card-body p-4">
                                                    <div class="row g-3">
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">Kargo Ücreti:</span>
                                                                <span class="fw-bold fs-5 text-success">
                                                                    @offer.Amount.ToString("C", offer.Currency switch{"TR"=>CultureInfo.GetCultureInfo("tr-TR"),"USD"=>CultureInfo.GetCultureInfo("en-US")})
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">Vergi:</span>
                                                                <span class="fw-semibold">
                                                                    @offer.AmountTax.ToString("C", offer.Currency switch{"TR"=>CultureInfo.GetCultureInfo("tr-TR"),"USD"=>CultureInfo.GetCultureInfo("en-US")})
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">Teslimat Süresi:</span>
                                                                <span class="fw-semibold text-info">
                                                                    <i class="bi bi-clock me-1"></i>@offer.DeliveryTime gün
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12 mt-3">
                                                            <hr class="my-2">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="fw-bold">Toplam:</span>
                                                                <span class="fw-bold fs-4 text-primary">
                                                                    @((offer.Amount + offer.AmountTax).ToString("C", offer.Currency switch{"TR"=>CultureInfo.GetCultureInfo("tr-TR"),"USD"=>CultureInfo.GetCultureInfo("en-US")}))
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                        <div class="container-fluid d-flex justify-content-center me-4">

                        </div>
                    </div>
                </div>
            }
        </div>
        <div class="container-fluid mt-4 ">
            @if (Model.SelectedTab <= 2){
                <div class="w-100 d-flex px-3 justify-content-end">
                    <button id="forwardBtn" onclick="assignCheckoutInputs();goForward(event);"
                            class="btn btn-success align-self-end" type="submit">Kargo Seçimine Geç</button>
                </div>
                <div class="w-100 d-flex px-3 justify-content-between">
                <button id="backBtn" class="btn d-none btn-outline-secondary" onclick="goBack(event)">Geri</button>
                <form class="d-none" id="proceedForm" method="post" hx-post="/@(nameof(Checkout))" hx-target="#InfoErrorResult" hx-swap="innerHTML">
                    <input id="@nameof(Address.City)Input" type="hidden" name="@(nameof(Checkout.Address)).@(nameof(Address.City))"/>
                    <input id="@nameof(Address.District)Input" type="hidden" name="@(nameof(Checkout.Address)).@(nameof(Address.District))"/>
                    <input id="@nameof(Address.Line1)Input" type="hidden" name="@(nameof(Checkout.Address)).@(nameof(Address.Line1))"/>
                    <input id="@(nameof(Address.Line2))Input" type="hidden" name="@(nameof(Checkout.Address)).@(nameof(Address.Line2))"/>
                    <input id="@nameof(Address.Country)Input" type="hidden" name="@(nameof(Checkout.Address)).@(nameof(Address.Country))"/>
                    <input id="@nameof(Address.ZipCode)Input" type="hidden" name="@(nameof(Checkout.Address)).@(nameof(Address.ZipCode))"/>
                    <input id="@(nameof(Checkout.Name))Input" type="hidden" name="@nameof(Checkout.Name)"/>
                    <input id="@(nameof(Checkout.Email))Input" type="hidden" name="@(nameof(Checkout.Email))"/>
                    <input id="countrycodeInput" type="hidden" name="@(nameof(Checkout.PhoneNumber)).@nameof(PhoneNumber.CountryCode)"/>
                    <input id="numberInput" type="hidden" name="@(nameof(Checkout.PhoneNumber)).@(nameof(PhoneNumber.Number))"/>
                    @foreach(var itemGroup in Model.Cart.Items.GroupBy(i => i.ProductOffer.Seller)){
                        <input type="hidden" id="group-@(itemGroup.Key.Id)-input" name="@(nameof(Checkout.SelectedShippingOffers))[@(itemGroup.Key.Id)]" value="@(Model.ShippingOffersGrouped[itemGroup.Key.Id].First().Id)"/>
                    }
                    <button type="submit" onclick="assignShippingInputs(event)" class="btn btn-success">Seçimleri Onayla</button>
                </form>    
                </div>
                
            }
        </div>
        <div class="container-fluid d-flex justify-content-center align-items-center">
            <div id="InfoErrorResult">
            </div>
        </div>
        <div class="tab-pane fade @(Model.SelectedTab==3?"show active":"")" id="nav-payment" role="tabpanel" aria-labelledby="nav-payment-tab">
            @if (Model.SelectedTab == 3){
                <div class="container-fluid">
                    <form class="container-fluid" id="paymentForm">
                        <div id="paymentElements">
                        </div>
                        <div class="d-flex container-fluid justify-content-center align-content-center">
                            <button class="btn btn-primary" type="button" onclick="sendPayment(event)" id="submitPayment">Ödemeyi Onayla</button>
                        </div>
                        <div id="errorMessage"></div>
                    </form>
                </div>
            }
        </div>
        <div class="tab-pane fade @(Model.SelectedTab == 4 ? "show active" : "")" id="nav-result" role="tabpanel" aria-labelledby="nav-result-tab">
            @if (Model.SelectedTab == 4){
                <div class="container-fluid ps-5">
                    @{ var (title, text) = Model.OrderResult switch{
                           Checkout.Result.Success => ("Sipariş Başarılı", "Siparişiniz başarı ile tamamlandı ve satıcıya bildirildi. Sipariş detaylarını aşağıda görüntüleyebilirsiniz"),
                           Checkout.Result.Fail => ("Ödeme Başarısız", "Ödemeniz başarısız, lütfen tekrar deneyin"),
                           Checkout.Result.NonExistent => ("Aktif Sipariş Yok", "İşlenmekte olan aktif siparişiniz yok. Lütfen yeni sipariş oluşturun")
                       };
                    }
                    <div class="container-fluid mb-3">
                        <p class="fs-3 text-center w-100 fw-bold ms-2">@title</p>
                        @await Html.PartialAsync("Shared/_SeperatorPartial", (3,4, "text-dark"))
                        <p class="text-start fs-5">@text</p>
                        <div class="card container-fluid pt-2 rounded-3 mx-0 mt-3 shadow-lg">
                            <div class="container-fluid d-flex justify-content-start mb-3">
                                <p class="fs-4 fw-bold">Sipariş Detayları</p>
                            </div>
                            <div id="order">
                                @await Html.PartialAsync("Shared/Order/_OrderListPartial", new _OrderListPartial{
                                    Orders = [Model.CreatedOrder],
                                    Url = null,
                                    Collapsable = false
                                })
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>
